var StudyDeck=function(deck_obj,deck_master){this.deck_obj=deck_obj,this.deck_index=null,this.cards=[],this.master=deck_master,this.bin1=[],this.bin2=[],this.bin3=[],this.learned=[],this.draw_number=null,this.current_card_data=null,this.deck_stats_key=null,this.init=function(deck_index){$("#modalSharedDeck").length>0&&$("#modalSharedDeck").modal("hide"),this.hide_response_buttons(),this.current_deck=this.deck_obj.decks[deck_index],this.instructor_offset=0,$("#study-deck-title").html(void 0!==this.current_deck.user_readable_name?this.current_deck.user_readable_name:this.current_deck.name),$("#study-deck-author").html(void 0!==this.current_deck.user_disp_name?"by: "+this.current_deck.user_disp_name:""),self=this,$.each(this.deck_obj.decks,function(index,thisdeck){"self"==thisdeck.access&&(self.instructor_offset=index+1)}),this.deck_index=deck_index,this.draw_number=0,self2=this,"self"==this.deck_obj.decks[this.deck_index].access?this.deck_obj.load_cards(deck_index,"deck").success(function(cards){self2.cards=cards,self2.deck_stats_key=self2.current_deck.name+"_"+self2.deck_obj.user,self2.current_deck.user_id=self2.deck_obj.user,self2.setup_stats(),self2.clear_slider(),self2.show_deck_starter(),$("#study-deck-title-length").html("("+self2.cards.length+" cards)")}):"instructor"==this.deck_obj.decks[this.deck_index].access?(self2=this,$("#shared-deck-browser .item").remove(),this.deck_obj.load_shared_deck(deck_index,deck_index-this.instructor_offset).success(function(cards){self2.cards=cards,self2.deck_stats_key=self2.current_deck.name+"_"+self2.current_deck.user_id,self2.setup_stats(),self2.clear_slider(),self2.show_deck_starter(),$("#study-deck-title-length").html("("+self2.cards.length+" cards)")})):(self2=this,$("#shared-deck-browser .notecard-container").remove(),this.deck_obj.load_shared_deck(deck_index).success(function(cards){self2.cards=cards,self2.deck_stats_key=self2.current_deck.name+"_"+self2.current_deck.user_id,self2.setup_stats(),self2.clear_slider(),self2.show_deck_starter(),$("#study-deck-title-length").html("("+self2.cards.length+" cards)")}))},this.setup_stats=function(){void 0!==this.master.study_stats[this.deck_stats_key]?(study_stats=this.master.study_stats[this.deck_stats_key],this.load_study(study_stats)):this.start_new_study(),this.update_stats()},this.load_study=function(study_stats){void 0!==study_stats.bin1?this.bin1=study_stats.bin1:this.bin1=[],void 0!==study_stats.bin2?this.bin2=study_stats.bin2:this.bin2=[],void 0!==study_stats.bin3?this.bin3=study_stats.bin3:this.bin3=[],void 0!==study_stats.learned?this.learned=study_stats.learned:this.learned=[],this.cards.forEach(function(card,index){this.bin1.indexOf(card.uid)<0&&this.bin2.indexOf(card.uid)<0&&this.bin3.indexOf(card.uid)<0&&this.learned.indexOf(card.uid)<0&&this.bin1.push(card.uid)},this),this.bin1_removal=[],this.bin1.forEach(function(uid,index){matches=$.grep(this.cards,function(card,index){return card.uid==uid}),matches.length<1&&this.bin1_removal.push(index)},this),this.bin2_removal=[],this.bin2.forEach(function(uid,index){matches=$.grep(this.cards,function(card,index){return card.uid==uid}),matches.length<1&&this.bin2_removal.push(index)},this),this.bin3_removal=[],this.bin3.forEach(function(uid,index){matches=$.grep(this.cards,function(card,index){return card.uid==uid}),matches.length<1&&this.bin3_removal.push(index)},this),this.learned_removal=[],this.learned.forEach(function(uid,index){matches=$.grep(this.cards,function(card,index){return card.uid==uid}),matches.length<1&&this.learned_removal.push(index)},this),this.bin1_removal.forEach(function(bin_index,index){this.bin1.splice(bin_index,1)},this),this.bin2_removal.forEach(function(bin_index,index){this.bin2.splice(bin_index,1)},this),this.bin3_removal.forEach(function(bin_index,index){this.bin3.splice(bin_index,1)},this),this.learned_removal.forEach(function(bin_index,index){this.learned.splice(bin_index,1)},this)},this.start_new_study=function(){self=this,this.bin1=[],this.bin2=[],this.bin3=[],this.learned=[],$.each(this.cards,function(index,card){self.bin1.push(card.uid)})},this.save_study_stats=function(){return postData={},postData.bin1=this.bin1,postData.bin2=this.bin2,postData.bin3=this.bin3,postData.learned=this.learned,postData.deck_name=this.current_deck.name,postData.user_id=this.current_deck.user_id,self=this,$.ajax({url:"/cp/flashcards/saveStudyStats/",type:"post",data:postData,dataType:"json"}).success(function(data){data.success===!0&&(self.master.study_stats[postData.deck_name+"_"+postData.user_id]=postData)}),postData},this.random_index=function(bin){return Math.floor(Math.random()*bin.length)},this.draw_card=function(){if(this.draw_number=this.draw_number+1,this.draw_number%16==0){if(this.bin3.length>0)return[this.bin3[this.random_index(this.bin3)],3];if(this.bin2.length>0)return[this.bin2[this.random_index(this.bin2)],2];if(this.bin1.length>0)return[this.bin1[this.random_index(this.bin1)],1]}else if(this.draw_number%4==0){if(this.bin2.length>0)return[this.bin2[this.random_index(this.bin2)],2];if(this.bin1.length>0)return[this.bin1[this.random_index(this.bin1)],1];if(this.bin3.length>0)return[this.bin3[this.random_index(this.bin3)],3]}else{if(this.bin1.length>0)return[this.bin1[this.random_index(this.bin1)],1];if(this.bin2.length>0)return[this.bin2[this.random_index(this.bin2)],2];if(this.bin3.length>0)return[this.bin3[this.random_index(this.bin3)],3]}return[null,0]},this.answer_card=function(uid,answer,bin_number){answer===!0?this.promote(uid,bin_number):this.demote(uid,bin_number)},this.learned_card=function(uid,bin_number){1==bin_number?(this.learned[this.learned.length]=uid,this.bin1=$.grep(this.bin1,function(elet){return elet!==uid})):2==bin_number?(this.learned[this.learned.length]=uid,this.bin2=$.grep(this.bin2,function(elet){return elet!==uid})):3==bin_number&&(this.learned[this.learned.length]=uid,this.bin3=$.grep(this.bin3,function(elet){return elet!==uid}))},this.promote=function(uid,bin_number){1==bin_number?(this.bin2[this.bin2.length]=uid,this.bin1=$.grep(this.bin1,function(elet){return elet!==uid})):2==bin_number?(this.bin3[this.bin3.length]=uid,this.bin2=$.grep(this.bin2,function(elet){return elet!==uid})):3==bin_number&&(this.learned[this.learned.length]=uid,this.bin3=$.grep(this.bin3,function(elet){return elet!==uid}))},this.demote=function(uid,bin_number){2==bin_number?(this.bin1[this.bin1.length]=uid,this.bin2=$.grep(this.bin2,function(elet){return elet!==uid})):3==bin_number&&(this.bin2[this.bin2.length]=uid,this.bin3=$.grep(this.bin3,function(elet){return elet!==uid}))},this.retrieve_card=function(uid){return card_a=$.grep(this.cards,function(card){return card.uid==uid}),card_a[0]},this.start=function(){this.current_card_data=this.draw_card(),$(".study-deck-starter").hide(),null!==this.current_card_data[0]?(card=this.retrieve_card(this.current_card_data[0]),this.slide_card_in(card),this.show_reveal_button()):(this.update_stats(),this.hide_reveal_button())},this.reset_stats=function(){this.start_new_study(),this.save_study_stats(),this.update_stats(),$("#start_study").show()},this.right=function(){this.hide_response_buttons(),$("#answer-instructions").hide(),this.promote(this.current_card_data[0],this.current_card_data[1]),this.slide_card_out("right"),this.current_card_data=this.draw_card(),null!==this.current_card_data[0]?(card=this.retrieve_card(this.current_card_data[0]),this.slide_card_in(card)):($(".study-deck-starter").show(),$("#start_study").hide()),this.update_stats(),this.save_study_stats()},this.wrong=function(){$("#answer-instructions").hide(),this.hide_response_buttons(),this.demote(this.current_card_data[0],this.current_card_data[1]),this.slide_card_out("left"),this.current_card_data=this.draw_card(),null!==this.current_card_data[0]?(card=this.retrieve_card(this.current_card_data[0]),this.slide_card_in(card)):($(".study-deck-starter").show(),$("#start_study").hide()),this.update_stats(),this.save_study_stats()},this.totally_learned=function(){$("#answer-instructions").hide(),this.hide_response_buttons(),this.learned_card(this.current_card_data[0],this.current_card_data[1]),this.slide_card_out("right"),this.current_card_data=this.draw_card(),null!==this.current_card_data[0]?(card=this.retrieve_card(this.current_card_data[0]),this.slide_card_in(card)):($(".study-deck-starter").show(),$("#start_study").hide()),this.update_stats(),this.save_study_stats()},this.clear_slider=function(){$("#modalPlayDeck .modal-body .study-deck-card").empty()},this.show_deck_starter=function(){$(".study-deck-starter").show(),this.hide_reveal_button(),this.learned.length==this.cards.length?$("#start_study").hide():$("#start_study").show()},this.update_stats=function(){$("#cards-new").html(this.bin1.length),$("#cards-familiar").html(this.bin2.length),$("#cards-mastering").html(this.bin3.length),$("#cards-learned").html(this.learned.length),$("#study-deck-cards-learned").html(this.learned.length),$("#study-deck-size").html(this.cards.length)},this.hide_reveal_button=function(){$("#reveal_card").hide()},this.show_reveal_button=function(){$("#reveal_card").show()},this.disable_reveal_button=function(){$("#reveal_card").off("click"),$("#reveal_card").addClass("disabled")},this.enable_reveal_button=function(){$("#reveal_card").on("click",function(){$("#study_slider .notecard-content").flip(!0)}),$("#reveal_card").removeClass("disabled")},this.show_response_buttons=function(){$(".response-buttons").show()},this.hide_response_buttons=function(){$(".response-buttons").hide()},this.flip_listener=function(){self=this,$("#study_slider .notecard-content").on("flip:done",function(){self.disable_reveal_button(),self.show_response_buttons(),$("body").off("keydown"),$("body").keydown(function(event){87==event.which&&self.wrong(),82==event.which&&self.right(),77==event.which&&self.totally_learned()})})},this.flipevent=null,this.slide_card_in=function(card){$("#study_slider").length<1&&$("#modalPlayDeck .modal-body .study-deck-card").append('<div id="study_slider" class="row" style="display:none"></div>'),$("#study_slider").append(this.deck_obj.play_card_template(card,"6 col-md-offset-3")),$("#study_slider .notecard-content").flip({trigger:"click",axis:"x",autoSize:!1}),this.flip_listener(),$("#study_slider").show("slide",{direction:"left"}),self=this,$("body").off("keydown"),$("#flip-instructions").show(),$("body").keydown(function(event){32==event.which&&$("#study_slider .notecard-content").flip(!0),self.flipevent=event}),this.enable_reveal_button()},this.slide_card_out=function(direction){$("#study_slider").hide("slide",{direction:direction,duration:500,complete:function(){$("#study_slider .notecard-container:first").remove()}}),$("body").off("keydown")}};
